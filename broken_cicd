trigger:
  branches:
    include:
    - "*"

pool:
  vmImage: ubuntu-latest

# REPLACE <YOUR_IMAGE_REPO> AND <YOUR_IMAGE_TAG> WITH YOUR VALUES

variables:
- group: cs_falcon_vars
#- name: CONTAINER_REPO
#  value: newimage
#- name: CONTAINER_TAG
#  value: 'latest'
- name: FALCON_CLOUD_REGION
  value: 'us-2'
- name: SCORE
  value: 500000

steps:

- task: Docker@2
  inputs:
    repository: $(CONTAINER_REPO)
    tags: $(CONTAINER_TAG)
    command: 'build'
    Dockerfile: '**/Dockerfile'
  displayName: 'Build container image'

# Tag container image 
- task: CmdLine@2
  inputs:
    script: 'docker tag $(CONTAINER_REPO):latest jmckenzieACR/$(CONTAINER_REPO)'
  displayName: 'Tag container image'

- task: Docker@2
  inputs:
    containerRegistry: 'jmckenzieACR'
    repository: 'jmckenzieACR/nginx'
#    tags: 'latest'
    command: 'push'

- script: |
    export FALCON_CLIENT_SECRET=$(FALCON_CLIENT_SECRET)
    export FALCON_CLIENT_ID=$(FALCON_CLIENT_ID)
    pip3 install docker crowdstrike-falconpy
    pip install retry
    if [ ! -d container-image-scan ] ; then
      git clone https://github.com/crowdstrike/container-image-scan
    fi
    python3 container-image-scan/cs_scanimage.py
  displayName: 'Scan container-image'
  
